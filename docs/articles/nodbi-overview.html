<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>nodbi - package overview • nodbi</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="nodbi - package overview">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nodbi</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.12.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/nodbi-overview.html">nodbi - package overview</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ropensci/nodbi/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>nodbi - package overview</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/nodbi/blob/HEAD/vignettes/nodbi-overview.Rmd" class="external-link"><code>vignettes/nodbi-overview.Rmd</code></a></small>
      <div class="d-none name"><code>nodbi-overview.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>R package <code>nodbi</code> provides a single interface for several
NoSQL databases and SQL databases with JSON functionality, with the same
function parameters and return values across all of:</p>
<ul>
<li>MongoDB</li>
<li>SQLite</li>
<li>PostgreSQL</li>
<li>DuckDB</li>
<li>Elasticsearch</li>
<li>CouchDB</li>
</ul>
<p>Package <code>nodbi</code> has been designed to use any specific SQL
functions a database may have for <code>JSON</code> and has added
functionality tested for performance to enable switching databases
without changing user code.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/nodbi/">nodbi</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="functionality">Functionality<a class="anchor" aria-label="anchor" href="#functionality"></a>
</h2>
<div class="section level3">
<h3 id="connect">Connect<a class="anchor" aria-label="anchor" href="#connect"></a>
</h3>
<p>First, a connection to a database is opened. In the example, no
additional parameters are used such as database file or server; see the
help page for the respective database.</p>
<p>“Container” is used as term to indicate where conceptually the
database holds the data (e.g. a collection in MongoDB, a table in
DuckDB). The <code>key</code> parameter of <code>nodbi</code> functions
holds the name of the relevant container.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># name of container</span></span>
<span><span class="va">key</span> <span class="op">&lt;-</span> <span class="st">"my_container"</span></span>
<span></span>
<span><span class="co"># nodbi can connect any of these databases</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">src</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/src_duckdb.html">src_duckdb</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">src</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/src_mongo.html">src_mongo</a></span><span class="op">(</span>collection <span class="op">=</span> <span class="va">key</span><span class="op">)</span></span>
<span>  <span class="va">src</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/src_sqlite.html">src_sqlite</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">src</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/src_postgres.html">src_postgres</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">src</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/src_elastic.html">src_elastic</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">src</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/src_couchdb.html">src_couchdb</a></span><span class="op">(</span></span>
<span>    user <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"COUCHDB_TEST_USER"</span><span class="op">)</span>,</span>
<span>    pwd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"COUCHDB_TEST_PWD"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># this example is run with</span></span>
<span><span class="va">src</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/src_sqlite.html">src_sqlite</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># note additional parameters can be specified,</span></span>
<span><span class="co"># for example for local or remote MongoDb:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/help.html" class="external-link">help</a></span><span class="op">(</span><span class="st">"src_mongo"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="docdb_create">docdb_create<a class="anchor" aria-label="anchor" href="#docdb_create"></a>
</h3>
<p>Create a container if it does not yet exist and fill with
<code>value</code>. The return value is the number of created documents.
“Documents” refers to the rows in a data frame such as
<code>mtcars</code>, or the number of <code>NDJSON</code> lines, or the
number of list items, or the number of objects in an <code>JSON</code>
array.</p>
<p>The parameter <code>value</code> in any <code>nodbi</code> function
can take a data frame, a list, a JSON string, or a file name or URL
pointing to <code>NDJSON</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># check if container already exists</span></span>
<span><span class="fu"><a href="../reference/docdb_exists.html">docdb_exists</a></span><span class="op">(</span>src <span class="op">=</span> <span class="va">src</span>, key <span class="op">=</span> <span class="va">key</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span></span>
<span><span class="co"># load data from a data frame with row names into</span></span>
<span><span class="co"># the container specified in "key" parameter</span></span>
<span><span class="fu"><a href="../reference/docdb_create.html">docdb_create</a></span><span class="op">(</span>src <span class="op">=</span> <span class="va">src</span>, key <span class="op">=</span> <span class="va">key</span>, value <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 32</span></span>
<span></span>
<span><span class="co"># do not run during testing</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># load additionally 98 NDJSON records</span></span>
<span>  <span class="fu"><a href="../reference/docdb_create.html">docdb_create</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, <span class="st">"https://httpbin.org/stream/98"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># load additionally mapdata as list</span></span>
<span><span class="fu"><a href="../reference/docdb_create.html">docdb_create</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">mapdata</span>, simplifyVector <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: container 'my_container' already exists</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span></span>
<span><span class="co"># show JSON structure of contacts</span></span>
<span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/prettify.html" class="external-link">minify</a></span><span class="op">(</span><span class="va">contacts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [{"_id":"5cd67853f841025e65ce0ce2","isActive":false,"balance":"$3,808.45","age":23,"eyeColor":"green","name":"Lacy Chen","email":"lacychen@conjurica.com","about":"Sunt consequat ad dolore.\nExercitation nisi reprehenderit.","registered":"2014-08-03T12:11:54 -02:00","tags":["nulla","nisi","adipisicing","do","ad","ullamco","irure"],"friends":[{"id":0,"name":"Wooten Goodwin"},{"id":1,"name":"Brandie Woodward"},{"id":2,"name":"Angelique Britt"}]},{"_id":"5cd678531b423d5f04cfb0a1","isActive":false,"balance":"$3,400.50","age":20,"eyeColor":"brown","name":"Rae Colon","email":"raecolon@conjurica.com","about":"Nisi excepteur duis duis aliquip qui id consequat consequat.","registered":"2018-12-19T06:23:35 -01:00","tags":["nostrud","eu","consectetur","adipisicing","labore","ut","voluptate"],"friends":[{"id":0,"name":"Yang Yates"},{"id":1,"name":"Lacy Chen"}]},{"_id":"5cd6785335b63cb19dfa8347","isActive":false,"balance":"$2,579.09","age":30,"eyeColor":"brown","name":"Williamson French","email":"williamsonfrench@conjurica.com","about":"Nulla do sunt consectetur officia. Laboris pariatur incididunt.","registered":"2018-02-14T10:59:57 -01:00","tags":["exercitation","do","magna","ut","consectetur","ex","incididunt"],"friends":[{"id":0,"name":"Coleen Dunn"},{"id":1,"name":"Doris Phillips"},{"id":2,"name":"Concetta Turner"}]},{"_id":"5cd6785325ce3a94dfc54096","isActive":true,"balance":"$1,161.52","age":22,"eyeColor":"brown","name":"Pace Bell","email":"pacebell@conjurica.com","about":"Eiusmod sunt laborum ipsum do cupidatat qui id dolore do.","registered":"2018-08-17T12:23:42 -02:00","tags":["aliqua","consectetur","commodo","velit","cupidatat","duis","dolore"],"friends":[{"id":0,"name":"Baird Keller"},{"id":1,"name":"Francesca Reese"},{"id":2,"name":"Dona Bartlett"}]},{"_id":"5cd678530df22d3625ed8375","isActive":true,"balance":"$2,412.67","age":20,"eyeColor":"blue","name":"Krista Baxter","email":"kristabaxter@conjurica.com","about":"Sint quis nulla ea fugiat. Commodo nisi qui eu sit.","registered":"2017-07-19T05:03:47 -02:00","tags":["sit","cillum","commodo","labore","sint","in","exercitation"],"friends":[{"id":0,"name":"Pace Bell"}]}]</span></span>
<span></span>
<span><span class="co"># load additionally contacts JSON data</span></span>
<span><span class="fu"><a href="../reference/docdb_create.html">docdb_create</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, <span class="va">contacts</span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: container 'my_container' already exists</span></span>
<span><span class="co">#&gt; [1] 5</span></span></code></pre></div>
<p>Check and list any other containers exist in the database:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/docdb_list.html">docdb_list</a></span><span class="op">(</span>src <span class="op">=</span> <span class="va">src</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "my_container"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="identifiers">Identifiers<a class="anchor" aria-label="anchor" href="#identifiers"></a>
</h3>
<p>The unique document identifier is its <code>_id</code>, corresponding
to a primary index with a constraint to be unique in SQL databases.</p>
<p>The <code>_id</code>’s of an input <code>value</code> are either the
row names of a data frame (such as <code>mtcars</code>) or top-level
elements with the name <code>_id</code> such as in <code>contacts</code>
shown just above.</p>
<p>Thus, expect a warning when trying to create documents with
<code>_id</code>’s that already exist in the container.</p>
<p>The return value can be <code>0</code> when no documents could newly
be created, or the number of the subset of documents in
<code>value</code> that did not yet exist and could newly be
created.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># zero new documents created</span></span>
<span><span class="fu"><a href="../reference/docdb_create.html">docdb_create</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, value <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co">#&gt; Note: container 'my_container' already exists</span></span>
<span><span class="co">#&gt; Warning: Could not create some documents, reason: UNIQUE constraint failed</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>For updating existing documents, see below function
<code><a href="../reference/docdb_update.html">docdb_update()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="docdb_get">docdb_get<a class="anchor" aria-label="anchor" href="#docdb_get"></a>
</h3>
<p>All documents in a container can now be retrieved with
<code><a href="../reference/docdb_get.html">docdb_get()</a></code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># use library for more</span></span>
<span><span class="co"># readable print output</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># get all documents, irrespective of schema</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="../reference/docdb_get.html">docdb_get</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># get just 2 documents using limit and note that</span></span>
<span>  <span class="co"># only fields for these documents are returned</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="../reference/docdb_get.html">docdb_get</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, limit <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loading required package: tibble</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 11</span></span></span>
<span><span class="co">#&gt;   `_id`       isActive balance   age eyeColor name  email about registered tags </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;lis&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 5cd678530d… TRUE     $2,412…    20 blue     Kris… kris… Sint… 2017-07-1… <span style="color: #949494;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 5cd678531b… FALSE    $3,400…    20 brown    Rae … raec… Nisi… 2018-12-1… <span style="color: #949494;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: friends &lt;list&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="docdb_query">docdb_query<a class="anchor" aria-label="anchor" href="#docdb_query"></a>
</h3>
<p>One of the most powerful functions of <code>nodbi</code> is
<code><a href="../reference/docdb_query.html">docdb_query()</a></code> because it permits to combine a query to
select documents and to filter for fields of interest.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># query for some documents</span></span>
<span><span class="fu"><a href="../reference/docdb_query.html">docdb_query</a></span><span class="op">(</span>src <span class="op">=</span> <span class="va">src</span>, key <span class="op">=</span> <span class="va">key</span>, query <span class="op">=</span> <span class="st">'{"mpg": {"$gte": 30}}'</span><span class="op">)</span></span>
<span><span class="co">#&gt;              _id  mpg cyl disp  hp drat    wt  qsec vs am gear carb</span></span>
<span><span class="co">#&gt; 1       Fiat 128 32.4   4 78.7  66 4.08 2.200 19.47  1  1    4    1</span></span>
<span><span class="co">#&gt; 2    Honda Civic 30.4   4 75.7  52 4.93 1.615 18.52  1  1    4    2</span></span>
<span><span class="co">#&gt; 3 Toyota Corolla 33.9   4 71.1  65 4.22 1.835 19.90  1  1    4    1</span></span>
<span><span class="co">#&gt; 4   Lotus Europa 30.4   4 95.1 113 3.77 1.513 16.90  1  1    5    2</span></span></code></pre></div>
<p>Both parameters <code>query</code> (obligatory) and
<code>fields</code> (optional) use, across all databases, MongoDB syntax
such as documented for <a href="https://www.mongodb.com/docs/manual/crud/" class="external-link">queries</a> and <a href="https://www.mongodb.com/docs/manual/tutorial/project-fields-from-query-results/" class="external-link">fields</a>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># query some fields from some documents; 'query' is a mandatory</span></span>
<span><span class="co"># parameter and is used here in its position in the signature</span></span>
<span><span class="fu"><a href="../reference/docdb_query.html">docdb_query</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, <span class="st">'{"mpg": {"$gte": 30}}'</span>, fields <span class="op">=</span> <span class="st">'{"wt": 1, "mpg": 1}'</span><span class="op">)</span></span>
<span><span class="co">#&gt;              _id    wt  mpg</span></span>
<span><span class="co">#&gt; 1       Fiat 128 2.200 32.4</span></span>
<span><span class="co">#&gt; 2    Honda Civic 1.615 30.4</span></span>
<span><span class="co">#&gt; 3 Toyota Corolla 1.835 33.9</span></span>
<span><span class="co">#&gt; 4   Lotus Europa 1.513 30.4</span></span></code></pre></div>
<p>Unless <code>fields</code> specifies <code>"_id": 0</code>, the
<code>_id</code> field is always included in the output of
<code><a href="../reference/docdb_query.html">docdb_query()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># query some fields from some documents, limit return to one document</span></span>
<span><span class="fu"><a href="../reference/docdb_query.html">docdb_query</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, <span class="st">'{"mpg": {"$gte": 30}}'</span>, fields <span class="op">=</span> <span class="st">'{"_id": 0, "mpg": 1}'</span>, limit <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span><span class="co">#&gt;    mpg</span></span>
<span><span class="co">#&gt; 1 32.4</span></span></code></pre></div>
<p>Queries can be more complex such as in this example, showing a dot
notation of a sub-field and an example operator (regular
expression).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># query some subitem fields from some documents</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="../reference/docdb_query.html">docdb_query</a></span><span class="op">(</span></span>
<span>  <span class="va">src</span>, <span class="va">key</span>,</span>
<span>  query <span class="op">=</span> <span class="st">'{"$or": [{"age": {"$gt": 21}},</span></span>
<span><span class="st">           {"friends.name": {"$regex": "^B[a-z]{3,9}.*"}}]}'</span>,</span>
<span>  fields <span class="op">=</span> <span class="st">'{"age": 1, "friends.name": 1}'</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    3 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;  $ _id         : chr  "5cd67853f841025e65ce0ce2" "5cd6785335b63cb19dfa8347" "5cd6785325ce3a94dfc54096"</span></span>
<span><span class="co">#&gt;  $ age         : int  23 30 22</span></span>
<span><span class="co">#&gt;  $ friends.name:List of 3</span></span>
<span><span class="co">#&gt;   ..$ : chr  "Wooten Goodwin" "Brandie Woodward" "Angelique Britt"</span></span>
<span><span class="co">#&gt;   ..$ : chr  "Coleen Dunn" "Doris Phillips" "Concetta Turner"</span></span>
<span><span class="co">#&gt;   ..$ : chr  "Baird Keller" "Francesca Reese" "Dona Bartlett"</span></span></code></pre></div>
<p>Queries work across documents of different structure such as
here.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># query with results across documents</span></span>
<span><span class="fu"><a href="../reference/docdb_query.html">docdb_query</a></span><span class="op">(</span></span>
<span>  <span class="va">src</span>, <span class="va">key</span>,</span>
<span>  query <span class="op">=</span> <span class="st">'{"$or": [{"age": {"$gt": 21}}, {"mpg": {"$gte": 30}}]}'</span>,</span>
<span>  fields <span class="op">=</span> <span class="st">'{"name": 1, "disp": 1}'</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;                        _id              name disp</span></span>
<span><span class="co">#&gt; 1                 Fiat 128              &lt;NA&gt; 78.7</span></span>
<span><span class="co">#&gt; 2              Honda Civic              &lt;NA&gt; 75.7</span></span>
<span><span class="co">#&gt; 3           Toyota Corolla              &lt;NA&gt; 71.1</span></span>
<span><span class="co">#&gt; 4             Lotus Europa              &lt;NA&gt; 95.1</span></span>
<span><span class="co">#&gt; 5 5cd67853f841025e65ce0ce2         Lacy Chen   NA</span></span>
<span><span class="co">#&gt; 6 5cd6785335b63cb19dfa8347 Williamson French   NA</span></span>
<span><span class="co">#&gt; 7 5cd6785325ce3a94dfc54096         Pace Bell   NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="field-names">Field names<a class="anchor" aria-label="anchor" href="#field-names"></a>
</h3>
<p>The <code>JSON</code> data handled by package <code>nodbi</code> may
have a large number of field included nested fields in objects (see for
example <code>name</code> within array <code>friends</code> above).
Thus, an argument is provided for <code><a href="../reference/docdb_query.html">docdb_query()</a></code> so that the
function returns only the comprehensive list of all field names in
documents selected with a query (or in all documents in the container if
<code>query = "{}"</code> is specified).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/docdb_query.html">docdb_query</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, query <span class="op">=</span> <span class="st">'{"_id": {"$regex": "^[0-9]"}}'</span>, listfields <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "about"                            "age"                             </span></span>
<span><span class="co">#&gt;  [3] "balance"                          "destination_addresses"           </span></span>
<span><span class="co">#&gt;  [5] "email"                            "eyeColor"                        </span></span>
<span><span class="co">#&gt;  [7] "friends"                          "friends.id"                      </span></span>
<span><span class="co">#&gt;  [9] "friends.name"                     "isActive"                        </span></span>
<span><span class="co">#&gt; [11] "name"                             "origin_addresses"                </span></span>
<span><span class="co">#&gt; [13] "registered"                       "rows"                            </span></span>
<span><span class="co">#&gt; [15] "rows.elements"                    "rows.elements.distance"          </span></span>
<span><span class="co">#&gt; [17] "rows.elements.distance.somevalue" "rows.elements.distance.text"     </span></span>
<span><span class="co">#&gt; [19] "rows.elements.duration"           "rows.elements.duration.somevalue"</span></span>
<span><span class="co">#&gt; [21] "rows.elements.duration.text"      "rows.elements.status"            </span></span>
<span><span class="co">#&gt; [23] "status"                           "tags"</span></span></code></pre></div>
<p>The dot notation is a path from a root field to the nested field, and
this notation can be used in <code>query</code> and <code>fields</code>
parameters of <code><a href="../reference/docdb_query.html">docdb_query()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="docdb_update">docdb_update<a class="anchor" aria-label="anchor" href="#docdb_update"></a>
</h3>
<p>Queries can also be used for updating (patching) selected documents
with a new <code>value</code>. The return value of
<code><a href="../reference/docdb_update.html">docdb_update()</a></code> corresponds to the number of documents that
were updated.</p>
<p>This is another powerful function because <code>value</code> can come
from a data frame, a list, a JSON string, or a file name or URL pointing
to <code>NDJSON</code>, and if <code>value</code> includes row names or
<code>_id</code>’s, these are used to identify the documents to be
updated.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># number of documents corresponding to query</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="../reference/docdb_query.html">docdb_query</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, query <span class="op">=</span> <span class="st">'{"carb": 3}'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span></span>
<span><span class="co"># update all documents using JSON, replacing the previously existing values</span></span>
<span><span class="fu"><a href="../reference/docdb_update.html">docdb_update</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, value <span class="op">=</span> <span class="st">'{"vs": 9, "xy": [1, 2]}'</span>, query <span class="op">=</span> <span class="st">'{"carb": 3}'</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span></span>
<span><span class="co"># update with value that includes _id's</span></span>
<span><span class="fu"><a href="../reference/docdb_update.html">docdb_update</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, value <span class="op">=</span> <span class="st">'{"_id": "Merc 450SLC", "xy": 33}'</span>, query <span class="op">=</span> <span class="st">"{}"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="co"># show updated values</span></span>
<span><span class="fu"><a href="../reference/docdb_query.html">docdb_query</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, query <span class="op">=</span> <span class="st">'{"carb": 3}'</span>, fields <span class="op">=</span> <span class="st">'{"xy": 1}'</span><span class="op">)</span></span>
<span><span class="co">#&gt;           _id   xy</span></span>
<span><span class="co">#&gt; 1  Merc 450SE 1, 2</span></span>
<span><span class="co">#&gt; 2  Merc 450SL 1, 2</span></span>
<span><span class="co">#&gt; 3 Merc 450SLC   33</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="docdb_delete">docdb_delete<a class="anchor" aria-label="anchor" href="#docdb_delete"></a>
</h3>
<p>Documents and containers can be deleted with
<code><a href="../reference/docdb_delete.html">docdb_delete()</a></code>. Its return value corresponds to the success
of the delete operation.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># number of documents corresponding to query</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="../reference/docdb_query.html">docdb_query</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, query <span class="op">=</span> <span class="st">'{"age": {"$lte": 23}}'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span></span>
<span><span class="co"># to delete selected documents, specify a query parameter</span></span>
<span><span class="fu"><a href="../reference/docdb_delete.html">docdb_delete</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span>, query <span class="op">=</span> <span class="st">'{"age": {"$lte": 23}}'</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="co"># this deletes the complete container from database</span></span>
<span><span class="fu"><a href="../reference/docdb_delete.html">docdb_delete</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="co"># check if still exists</span></span>
<span><span class="fu"><a href="../reference/docdb_exists.html">docdb_exists</a></span><span class="op">(</span><span class="va">src</span>, <span class="va">key</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="disconnect-and-shutdown">Disconnect and shutdown<a class="anchor" aria-label="anchor" href="#disconnect-and-shutdown"></a>
</h3>
<p>Package <code>nodbi</code> includes an automatic mechanism for
shutting down, at the time of <code><a href="https://rdrr.io/r/base/quit.html" class="external-link">quit()</a></code> or session restart,
those databases that require it (SQLite, DuckDB, PostgreSQL).</p>
<p>Nevertheless, it is good practice to manually disconnect and shut
down connections as specific to the database, for example for
SQLite:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">src</span></span>
<span><span class="co">#&gt; src: sqlite</span></span>
<span><span class="co">#&gt; SQLite library version: 3.49.1</span></span>
<span><span class="co">#&gt;  size: NA MB</span></span>
<span><span class="co">#&gt;  dbname: :memory:</span></span>
<span><span class="co">#&gt; Warning: Database is only in memory, will not persist after R ends! Consider to copy it with </span></span>
<span><span class="co">#&gt; RSQLite::sqliteCopyDatabase(</span></span>
<span><span class="co">#&gt;   from = &lt;your nodbi::src_sqlite() object&gt;$con, </span></span>
<span><span class="co">#&gt;   to = &lt;e.g. RSQLite::dbConnect(RSQLite::SQLite(), 'local_file.db')&gt;</span></span>
<span><span class="co">#&gt;   )</span></span>
<span></span>
<span><span class="co"># shutdown</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">src</span><span class="op">$</span><span class="va">con</span>, shutdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">src</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ralf Herold, Scott Chamberlain, Rich FitzJohn, Jeroen Ooms.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
